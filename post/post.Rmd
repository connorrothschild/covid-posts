---
title: "A Shiny App for 400+ Blog Posts on COVID-19 with R"
author: "Rees Morrison and Conor Rothschild"
date: "October 28, 2020" 
output: html_document
--- 

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.fullwidth = TRUE,
                      out.width = "100%",
                      dpi = 300)

library(tidyverse) # for a collection of frequently used packages that follow a similar coding approach
library(funModeling) # to compare vectors against each other, to find overlaps and inconsistencies
library(ggpmisc) # to put tables in plots
library(ggrepel) # to spread points or text so that they do not overlap on a plot
library(readxl) # to read in the underlying Excel data about the COVID-19 blog posts in R
library(viridis) # to use various palettes in ggplot
library(tidytext) # text-mining functions that help analyse the content of posts

library(cr)
set_cr_theme()
```


Our goal here is to help bloggers who want to analyze COVID-19 data by unleashing R and the resources of its community by being able to researching such posts (here, called "covidRposts). 

Having so far found 423 covidRposts in English, we have published a Shiny app for them. It lets users find the names of the 231 bloggers who wrote those covidRposts, their roles, and country. The app also lets users interactively search the collection of posts by primary topic, title, date, and whether the post used a particular mathematical technique and which source of data. To learn more about the evolution of this data set, one of the authors (Rees) has published nine articles on Medium. The most recent [Medium article](https://medium.com/@rees_32356/my-previous-nine-articles-have-each-focused-on-a-different-finding-from-an-ever-growing-set-of-e774fb608dbd ) links to the series.

If anyone has corrections to the data set or knows other blog posts that ought to be included in it, please write Rees (at) ReesMorrison (dot) com. The data set analyzed in this post is available on [GitHub](https://github.com/connorrothschild/covid-posts). 

The remainder of this post highlights some of the findings from the data set of COVID-19posts. The first plot displays the pace of blog postings. It shows the week of the year on the x-axis, starting in early-February, and the number of posts on the y-axis. As the pandemic has ground on and on, fewer bloggers have seized upon the data it has generated.

```{r weekly, echo = FALSE, warnings = FALSE}
posts <- readxl::read_excel(here::here("data/postsTopicsRoles1019.xlsx"))

month <- seq(as.Date("2020-01-01"),
             as.Date("2020-12-01"),
             by = "1 month")

month_numeric <- lubridate::yday(month) / 365 * 52 + 1
month_label <- lubridate::month(month, label = TRUE)

ggplot(posts, aes(x = Week)) +
  geom_histogram(stat = "count") +
  labs(
    x = element_blank(),
    y = "Number of Blog Posts",
    title = "Counts of Blog Posts that Use R to Analyze COVID-19 Data",
    subtitle = "English only, as of Oct. 20, 2020",
    caption = "Source: Rees Morrison compilation of COVID-19 blog posts that use R"
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(breaks = month_numeric,
                     labels = month_label)
```

Some bloggers have been prolific; many more have been one and done. For the 23 bloggers who have published at least four covidRposts, the plot below shows their names and their posts by week of 2020. For an example of how to read the plot, Tim Churches, at the bottom of the reverse alphabetical y-axis, has published a total of six posts, but none after early April. Note that the text boxes with the months are somewhat approximately located on the plot.

The color of the points corresponds to the work role of the blogger as explained in the legend at the bottom. It is immediately apparent that professors (blue) and academic researchers (red) predominate in this group of bloggers. If you include the postgraduate students, universities writ large account for nearly all of the prolific bloggers.

```{r prolificVer2}
# which bloggers have the most posts and set a cutoff (4); those are "freqBloggers"
prolific <-
  posts %>% select(LastName, Week) %>% group_by(LastName) %>% summarise(Count = n()) %>%
  arrange(desc(Count)) %>% ungroup()

freqBloggers <- prolific$LastName[1:13]

graphProlific <-
  posts %>% select(LastName, Week, Role) %>% 
  dplyr::filter(LastName %in% freqBloggers)

graphProlific %>% 
  mutate(LastName = fct_reorder(LastName, -desc(Role))) %>%
  ggplot(aes(x = Week, y = LastName, colour = Role)) +
  geom_point(pch = 20, size = 4) +
  # geom_jitter(pch = 20, size = 4, width = 0.1) +
  labs(
    x = element_blank(),
    y = element_blank(),
    colour = element_blank(),
    title = "Timing of Blog Posts that Use R to Analyze COVID-19 Data",
    subtitle = "Role of bloggers identified to date with more than four posts",
    caption = "Source: Rees Morrison compilation of COVID-19 blog posts that use R"
  ) +
  scale_x_continuous(breaks = month_numeric,
                     labels = month_label) +
  theme(legend.position = "bottom",
        legend.direction = 'horizontal')
```

We should explain "Role" a bit more. Bloggers, other than professors, describe their work-day roles in a variety of ways. One of the authors (Rees) standardized the multitude of terms and descriptions, but it is quite possible that this effort misrepresented what some of these bloggers do for a living. We welcome corrections. 

Going further, the next plot assigned the bloggers into the broader role categories. Those broader categories are represented as columns in the following chart.

```{r authorVer2, echo = FALSE, warnings = FALSE}
roles <-
  read_excel(here::here("data/NamesRolesEmailsTwo.Ver1.xls"), trim_ws = TRUE)

posts <- left_join(posts, roles[, 1:6])

roleSum <-
  posts %>% group_by(CoreRole, Role) %>% summarise(NumPosts = length(Author)) %>%
  arrange(desc(NumPosts)) %>% ungroup() #30

posts %>% 
  group_by(CoreRole) %>% 
  tally() %>% 
  filter(!is.na(CoreRole)) %>% 
  mutate(CoreRole = fct_reorder(CoreRole, -n)) %>% 
ggplot(aes(x = CoreRole, y = n)) +
  geom_col() +
  labs(
    x = element_blank(),
    y = "Number of Blog Posts",
    title = "Role of Authors that Use R to Analyze COVID-19 Data",
    subtitle = "As of Oct. 20, 2020",
    caption = "Source: Rees Morrison compilation of COVID-19 blog posts that use R"
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  theme(legend.position = "bottom",
        legend.direction = 'horizontal')
```

The more data sources the R community knows for purposes of exploring the coronavirus pandemic, the richer will be the insights. Combining different datasets can shed new light on an issue; inconsistencies between data sets can yield improvements; or better indices can be constructed. For that reason, one of the authors (Rees) extracted from the collection of blog posts information about their data sources.

For the most part, bloggers identified the data source they drew on for their analysis. However, standardizing that range of nearly 140 data sources was a challenge.

Notably, data from the US CDC is lacking. On the other hand is Johns Hopkins University, who early, comprehensively and consistently has set the standard for COVID-19 data collection and dissemination to the public.

```{r datasourcesVer2}
postsConnor <-
 read.csv(here::here("data/postsOct20423allText.csv")) # this has 442 obs as mistakes

textDF_data <- postsConnor %>% # 592 obs. of 3 vars June 20
 mutate(data = str_extract_all(postsConnor$text, pattern = "(?<=\\&Data).*?(?=&&)")) %>%
 unnest()

source(here::here('post/clean_text.R'))
```

```{css}
.header {
  text-transform: uppercase;
  font-size: 12px;
  font-weight: 400;
  border-bottom: 2px solid #555;
}
```

```{r dataTable}
textDF_data_gat <-
  textDF_data %>% filter(data %nin% c("Simulation", "No data")) %>%
  group_by(data) %>% summarise(Count = n()) %>%
  arrange(desc(Count)) %>% ungroup() %>% 
  filter(!is.na(data))

ggplot(subset(textDF_data_gat, Count > 3), aes(x = reorder(data, Count), y = Count)) +
  geom_col() +
  labs(
    x = NULL,
    y = "Number of Posts Using Data",
    title = "Most Common Data Sources for COVID-19 Blog Posts",
    subtitle = "Including data sources used more than three times, as of Oct. 20, 2020",
    caption = "Source: Rees Morrison compilation of COVID-19 blog posts that use R"
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  coord_flip()
```

Below, you can look at *all* data sources and how often they were referenced in COVID-19 blog posts.

```{r}
library(reactable)

reactable(
  textDF_data_gat,
  compact = TRUE,
  striped = TRUE,
  defaultColDef = colDef(headerClass = "header",
                         na = "â€“"),
  columns = list(data = colDef(name = 'Data Source'))
)
```

Bloggers and other analysts would like a thumbnail summary of blogs. Assigning each blog post a primary topic introduces a fair amount of subjectivity, to be sure, but the hope is that these broad topics will help researchers find content and colleagues who share similar interests. Here, a heat map shows nine categories that the 160+ blogs address as their primary topic. Epidemiology leads the way, as might be expected, but also quite a few posts seem to take the Covid data as an opportunity to show off a capability of the R programming language ("DataViz", "R Program" and "Statistics").

```{r topicsVer2}
# remove NAs and gather
topics <-
  posts %>% dplyr::filter(CoreRole != "NA" &
                            Country != "NA") %>% 
  group_by(CoreRole, Topic) %>% 
  summarise(Count = n()) %>%
  ungroup() # 41 obs

# reorder according to counts
topics$Topic <- ordered(
  topics$Topic,
  levels = topics %>% group_by(Topic) %>% summarise(n = sum(Count)) %>%
    arrange(n) %>% distinct() %>% pull(Topic)
)

topics$CoreRole <- ordered(
  topics$CoreRole,
  levels = topics %>% group_by(CoreRole) %>% summarise(n = sum(Count)) %>%
    arrange(desc(n)) %>% distinct() %>% pull(CoreRole)
)

# add a "row" column which will be the y position in the plot
topics <-
  topics %>% mutate(row = group_indices(topics, .dots = c('Topic')))

# add a "col" column which will be the x position in the plot
topics <-
  topics %>% mutate(col = group_indices(topics, .dots = c('CoreRole')))

# get character vector of variable names for the x axis. the order is important, hence arrange(col)!
vars_x_axis <-
  c(topics %>% arrange(col) %>% select(CoreRole) %>% distinct())$CoreRole
# get character vector of observation names for the y axis. again, the order is important but "topics" is already ordered
names_y_axis <-
  c(topics %>% arrange(row) %>% select(Topic) %>% distinct())$Topic

# pal <- wesanderson::wes_palette('IsleofDogs1', 5, type = "discrete")

ggplot(topics,
       aes(
         x = factor(col),
         y = factor(row),
         color = Topic,
         alpha = Count,
         size = Count
       )) +
  geom_label(
    aes(label = Count,
        x = col + 0.3),
    alpha = 1,
    size = 4,
    color = "black",
    label.size = 0,
    family = 'Lato'
  ) +
  geom_point() +
  scale_size_area(max_size = 10) +
  scale_alpha_continuous(range = c(0.5, 1)) +
  # scale_color_manual(values = pal) +
  scale_x_discrete(
    breaks = 1:length(vars_x_axis),
    labels = function(x)
      str_wrap(vars_x_axis, width = 10)
  ) +
  scale_y_discrete(breaks = 1:length(names_y_axis), labels = names_y_axis) +
  labs(title = 'Number of Posts by Topic and Employment Category',
       x = element_blank(),
       y = element_blank()) +
  theme(
    axis.line = element_blank(),
    panel.border = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    legend.position = 'none',
    text = element_text(colour = 'black',
                        family = 'Lato'),
    axis.text = element_text(size = 10.5),
    title = element_text(size = 14),
    plot.title.position = 'plot',
    axis.ticks = element_blank()
  )   
```


